name: Docker Image Mirror with Clear Logs

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Docker Authentication
      run: |
        echo "=== Setup Docker Auth ==="
        mkdir -p ~/.docker
        
        USERNAME="李彦超0305"
        PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
        
        echo "Username: $USERNAME"
        echo "Password length: ${#PASSWORD} chars"
        
        AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json
        echo "Auth configured"

    - name: Test Push with Clear Log
      run: |
        echo "=== Test Push ==="
        docker pull hello-world
        TEST_IMAGE="registry.cn-beijing.aliyuncs.com/liyanchao/php:clear-test"
        echo "Pushing to: $TEST_IMAGE"
        docker tag hello-world $TEST_IMAGE
        docker push $TEST_IMAGE
        echo "SUCCESS: Image pushed to $TEST_IMAGE"

    - name: Check Current Images
      run: |
        echo "=== Current local images ==="
        docker images | head -10

    - name: View images.txt Content
      run: |
        echo "=== images.txt Content ==="
        if [ -f "images.txt" ]; then
          cat images.txt
          echo "Total lines: $(wc -l < images.txt)"
        else
          echo "images.txt not found"
        fi

    - name: Sync Images with Progress
      run: |
        echo "=== Sync Images Progress ==="
        
        if [ ! -f "images.txt" ]; then
          echo "ERROR: images.txt not found"
          exit 1
        fi
        
        COUNT=0
        while IFS= read -r LINE; do
          # Skip empty lines and comments
          [[ -z "$LINE" ]] && continue
          [[ "$LINE" =~ ^[[:space:]]*# ]] && continue
          
          COUNT=$((COUNT + 1))
          echo "--- Processing image $COUNT ---"
          
          # Extract image name
          IMAGE=$(echo "$LINE" | awk '{print $NF}')
          echo "Source: $IMAGE"
          
          # Pull image
          docker pull $IMAGE
          
          # Create target name
          TARGET_NAME="registry.cn-beijing.aliyuncs.com/liyanchao/$(echo $IMAGE | sed 's|/|_|g' | sed 's|:|-|g')"
          echo "Target: $TARGET_NAME"
          
          # Tag and push
          docker tag $IMAGE $TARGET_NAME
          docker push $TARGET_NAME
          
          echo "SUCCESS: $TARGET_NAME"
          echo ""
          
        done < images.txt
        
        echo "=== SUMMARY ==="
        echo "Total images synced: $COUNT"
        echo "All images pushed to: registry.cn-beijing.aliyuncs.com/liyanchao/"