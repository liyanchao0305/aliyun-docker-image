name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Docker Authentication
      run: |
        echo "=== 设置 Docker 认证 ==="
        mkdir -p ~/.docker
        
        # 使用你的阿里云账号密码
        USERNAME="李彦超0305"
        PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
        
        # 生成认证信息
        AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)
        
        # 创建配置文件
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json
        
        echo "✅ 认证配置完成"
        echo "用户名: $USERNAME"
        echo "密码长度: ${#PASSWORD} 字符"

    - name: Simple Test to Existing Repo
      run: |
        echo "=== 简单测试推送到现有仓库 ==="
        
        # 拉取测试镜像
        docker pull hello-world
        echo "✅ hello-world 镜像拉取成功"
        
        # 推送到现有的 php 仓库
        TARGET_IMAGE="registry.cn-beijing.aliyuncs.com/liyanchao/php:hello-test"
        echo "准备推送到: $TARGET_IMAGE"
        
        docker tag hello-world $TARGET_IMAGE
        docker push $TARGET_IMAGE
        
        echo "✅ 测试推送成功！"
        echo "镜像已推送到: $TARGET_IMAGE"