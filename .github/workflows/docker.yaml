name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Docker Authentication
      run: |
        mkdir -p ~/.docker
        USERNAME="æå½¦è¶…0305"
        PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"  # æ­£ç¡®å¼•ç”¨
        
        AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json
        echo "âœ… è®¤è¯é…ç½®å®Œæˆ"

    - name: Sync Images
      run: |
        if [ ! -f "images.txt" ]; then
          echo "âŒ images.txt ä¸å­˜åœ¨"
          exit 1
        fi
        
        count=0
        while IFS= read -r line; do
          [[ -z "$line" ]] && continue
          [[ "$line" =~ ^# ]] && continue
          
          count=$((count + 1))
          image=$(echo "$line" | awk '{print $NF}')
          echo "å¤„ç†é•œåƒ: $image"
          
          docker pull $image
          new_name="registry.cn-beijing.aliyuncs.com/liyanchao/$(echo $image | sed 's|/|_|g' | sed 's|:|-|g')"
          docker tag $image $new_name
          docker push $new_name
          echo "âœ… å®Œæˆ"
          
        done < images.txt
        
        echo "ğŸ‰ æˆåŠŸåŒæ­¥ $count ä¸ªé•œåƒ"