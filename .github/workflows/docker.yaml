name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    # åœ¨è¿™é‡Œè®¾ç½®å…¨å±€çŽ¯å¢ƒå˜é‡
    env:
      ALIYUN_REGISTRY: "registry.cn-beijing.aliyuncs.com"
      ALIYUN_NAME_SPACE: "liyanchao"  # ä¿®æ”¹è¿™é‡Œæ¥æ”¹å˜ç›®æ ‡å‘½åç©ºé—´
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Configure Docker Authentication
      run: |
        mkdir -p ~/.docker
        cat > ~/.docker/config.json << EOF
        {
          "auths": {
            "${{ env.ALIYUN_REGISTRY }}": {
              "auth": "$(echo -n "æŽå½¦è¶…0305:${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | base64 | tr -d '\n')"
            }
          }
        }
        EOF
        echo "è®¤è¯é…ç½®å®Œæˆï¼Œç›®æ ‡ä»“åº“: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAME_SPACE }}/"

    - name: Test Push Simple Image
      run: |
        echo "ðŸš€ æµ‹è¯•æŽ¨é€åˆ°: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAME_SPACE }}/"
        docker pull hello-world
        test_image="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAME_SPACE }}/test-hello-world:latest"
        docker tag hello-world $test_image
        docker push $test_image
        echo "âœ… æµ‹è¯•é•œåƒå·²æŽ¨é€åˆ°: $test_image"