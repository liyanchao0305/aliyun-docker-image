name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Create Docker Config
      run: |
        echo "=== åˆ›å»º Docker é…ç½®æ–‡ä»¶ ==="
        
        # æ¸…é™¤æ—§é…ç½®
        rm -rf ~/.docker
        mkdir -p ~/.docker
        
        # ä½¿ç”¨æ­£ç¡®çš„ base64 ç¼–ç 
        AUTH=$(echo -n "æŽå½¦è¶…0305:${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | base64 -w 0)
        
        # åˆ›å»ºæ­£ç¡®çš„ JSON é…ç½®æ–‡ä»¶
        cat > ~/.docker/config.json << 'EOF'
{
  "auths": {
    "registry.cn-beijing.aliyuncs.com": {
      "auth": "REPLACE_AUTH"
    }
  }
}
EOF
        
        # æ›¿æ¢è®¤è¯ä¿¡æ¯
        sed -i "s|REPLACE_AUTH|$AUTH|g" ~/.docker/config.json
        
        echo "è®¤è¯æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        echo "æ–‡ä»¶å†…å®¹:"
        cat ~/.docker/config.json

    - name: Verify Config
      run: |
        echo "=== éªŒè¯é…ç½® ==="
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if [ -f ~/.docker/config.json ]; then
          echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < ~/.docker/config.json) bytes"
        else
          echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

    - name: Test Push
      run: |
        echo "=== æµ‹è¯•æŽ¨é€ ==="
        
        # æ‹‰å–æµ‹è¯•é•œåƒ
        docker pull hello-world
        
        # æµ‹è¯•æŽ¨é€
        docker tag hello-world registry.cn-beijing.aliyuncs.com/liyanchao/test-final:latest
        echo "å‡†å¤‡æŽ¨é€åˆ°: registry.cn-beijing.aliyuncs.com/liyanchao/test-final"
        
        # å°è¯•æŽ¨é€
        if docker push registry.cn-beijing.aliyuncs.com/liyanchao/test-final:latest; then
          echo "âœ… æŽ¨é€æˆåŠŸï¼è®¤è¯é…ç½®æ­£ç¡®"
        else
          echo "âŒ æŽ¨é€å¤±è´¥"
          echo "è°ƒè¯•ä¿¡æ¯:"
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "Docker ä¿¡æ¯:"
          docker info
          exit 1
        fi

    - name: Sync Images
      if: success()
      run: |
        echo "=== åŒæ­¥é•œåƒ ==="
        
        if [ ! -f "images.txt" ]; then
          echo "âŒ images.txt ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ˜¾ç¤º images.txt å†…å®¹
        echo "images.txt å†…å®¹:"
        cat images.txt
        echo ""
        
        # è®¡æ•°å™¨
        count=0
        
        # å¤„ç†é•œåƒ
        while IFS= read -r line; do
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
          if [[ -z "$line" ]]; then
            continue
          fi
          if [[ "$line" =~ ^[[:space:]]*# ]]; then
            continue
          fi
          
          count=$((count + 1))
          echo "--- å¤„ç†ç¬¬ $count ä¸ªé•œåƒ ---"
          echo "åŽŸå§‹è¡Œ: $line"
          
          # æå–é•œåƒåï¼ˆæœ€åŽä¸€ä¸ªå­—æ®µï¼‰
          image=$(echo "$line" | awk '{print $NF}')
          echo "é•œåƒå: $image"
          
          # æ‹‰å–é•œåƒ
          echo "æ‹‰å–é•œåƒ..."
          docker pull $image
          
          # ç”Ÿæˆæ–°é•œåƒåï¼ˆæ›¿æ¢ç‰¹æ®Šå­—ç¬¦ï¼‰
          new_name=$(echo "registry.cn-beijing.aliyuncs.com/liyanchao/$image" | sed 's|/|_|g' | sed 's|:|_|g')
          echo "ç›®æ ‡é•œåƒ: $new_name"
          
          # æ ‡è®°å’ŒæŽ¨é€
          echo "æ ‡è®°é•œåƒ..."
          docker tag $image $new_name
          
          echo "æŽ¨é€é•œåƒ..."
          docker push $new_name
          
          echo "âœ… å®Œæˆ: $new_name"
          echo ""
          
        done < images.txt
        
        if [ $count -eq 0 ]; then
          echo "âš ï¸  æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é•œåƒè¡Œ"
        else
          echo "ðŸŽ‰ æˆåŠŸåŒæ­¥ $count ä¸ªé•œåƒ"
        fi