name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Docker Authentication
      run: |
        echo "=== Setup Docker Auth ==="
        mkdir -p ~/.docker
        USERNAME="李彦超0305"
        PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
        AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json

    - name: Sync All Images
      run: |
        echo "=== Syncing All Images ==="
        
        if [ ! -f "images.txt" ]; then
          echo "ERROR: images.txt not found"
          exit 1
        fi
        
        echo "Images to sync:"
        cat images.txt
        echo ""
        
        COUNT=0
        while IFS= read -r IMAGE; do
          # Skip empty lines and comments
          [[ -z "$IMAGE" ]] && continue
          [[ "$IMAGE" =~ ^[[:space:]]*# ]] && continue
          
          COUNT=$((COUNT + 1))
          echo "--- Processing image $COUNT: $IMAGE ---"
          
          # Pull image
          docker pull $IMAGE
          
          # Create target name
          CLEAN_IMAGE=$(echo "$IMAGE" | sed 's|^docker.io/||' | sed 's|^library/||')
          REPO_NAME=$(echo "$CLEAN_IMAGE" | cut -d':' -f1 | sed 's|/|_|g')
          TAG=$(echo "$CLEAN_IMAGE" | cut -d':' -f2)
          [ "$TAG" = "$CLEAN_IMAGE" ] && TAG="latest"
          
          TARGET_NAME="registry.cn-beijing.aliyuncs.com/liyanchao/${REPO_NAME}:${TAG}"
          echo "Target: $TARGET_NAME"
          
          # Tag and push
          docker tag $IMAGE $TARGET_NAME
          docker push $TARGET_NAME
          
          echo "✅ SUCCESS: $IMAGE → $TARGET_NAME"
          echo ""
          
        done < images.txt
        
        echo "=== COMPLETED ==="
        echo "Total images synced: $COUNT"