name: Docker Image Mirror Fixed

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Docker Auth with Fixed Password
      run: |
        echo "=== ä½¿ç”¨å›ºå®šå¯†ç è®¾ç½®è®¤è¯ ==="
        mkdir -p ~/.docker
        
        # ç›´æ¥ä½¿ç”¨å›ºå®šå¯†ç 
        USERNAME="æå½¦è¶…0305"
        PASSWORD="aliyun123456"
        
        echo "ç”¨æˆ·å: $USERNAME"
        echo "å¯†ç : $PASSWORD"
        echo "å¯†ç é•¿åº¦: ${#PASSWORD} å­—ç¬¦"
        
        # ç”Ÿæˆè®¤è¯ä¿¡æ¯
        AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)
        echo "è®¤è¯Token: $AUTH"
        
        # åˆ›å»ºé…ç½®æ–‡ä»¶
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json
        
        echo "âœ… è®¤è¯é…ç½®å®Œæˆ"
        echo "é…ç½®æ–‡ä»¶å†…å®¹:"
        cat ~/.docker/config.json

    - name: Test Push with Fixed Auth
      run: |
        echo "=== æµ‹è¯•æ¨é€ ==="
        
        # æ‹‰å–æµ‹è¯•é•œåƒ
        docker pull hello-world
        echo "âœ… hello-world æ‹‰å–æˆåŠŸ"
        
        # æ¨é€åˆ°é˜¿é‡Œäº‘
        TARGET_IMAGE="registry.cn-beijing.aliyuncs.com/liyanchao/php:fixed-password-test"
        echo "å‡†å¤‡æ¨é€åˆ°: $TARGET_IMAGE"
        
        docker tag hello-world $TARGET_IMAGE
        docker push $TARGET_IMAGE
        
        echo "âœ… æ¨é€æµ‹è¯•æˆåŠŸï¼"

    - name: Sync Images
      if: success()
      run: |
        echo "=== åŒæ­¥é•œåƒ ==="
        
        if [ ! -f "images.txt" ]; then
          echo "âŒ images.txt ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "images.txt å†…å®¹:"
        cat images.txt
        echo ""
        
        count=0
        while IFS= read -r line; do
          [[ -z "$line" ]] && continue
          [[ "$line" =~ ^# ]] && continue
          
          count=$((count + 1))
          echo "å¤„ç†ç¬¬ $count ä¸ªé•œåƒ: $line"
          
          image=$(echo "$line" | awk '{print $NF}')
          docker pull $image
          
          # æ¨é€åˆ°ä¸åŒçš„ç°æœ‰ä»“åº“
          if [ $count -eq 1 ]; then
            repo="php"
          elif [ $count -eq 2 ]; then
            repo="nginx" 
          elif [ $count -eq 3 ]; then
            repo="mysql"
          else
            repo="other"
          fi
          
          target_image="registry.cn-beijing.aliyuncs.com/liyanchao/${repo}:mirror-${count}"
          docker tag $image $target_image
          docker push $target_image
          echo "âœ… å®Œæˆ: $target_image"
          
        done < images.txt
        
        echo "ğŸ‰ æˆåŠŸåŒæ­¥ $count ä¸ªé•œåƒ"