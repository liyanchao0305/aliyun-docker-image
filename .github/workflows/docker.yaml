name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Docker Auth
      run: |
        mkdir -p ~/.docker
        AUTH=$(echo -n "李彦超0305:${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | base64)
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json

    - name: Test Push
      run: |
        docker pull hello-world
        docker tag hello-world registry.cn-beijing.aliyuncs.com/liyanchao/test-hello:latest
        docker push registry.cn-beijing.aliyuncs.com/liyanchao/test-hello:latest

    - name: Sync Images
      run: |
        if [ -f "images.txt" ]; then
          while IFS= read -r line; do
            [[ -z "$line" ]] && continue
            [[ "$line" =~ ^# ]] && continue
            image=$(echo "$line" | awk '{print $NF}')
            echo "Processing: $image"
            docker pull $image
            new_name="registry.cn-beijing.aliyuncs.com/liyanchao/$(echo $image | tr '/:' '_-')"
            docker tag $image $new_name
            docker push $new_name
            echo "Done: $new_name"
          done < images.txt
        fi