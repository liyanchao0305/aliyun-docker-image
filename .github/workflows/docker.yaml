name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        # 确保以正确编码检出文件
        lfs: false

    - name: Setup Docker Authentication
      run: |
        echo "=== Setup Docker Auth ==="
        mkdir -p ~/.docker
        USERNAME="李彦超0305"
        PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
        AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json

    - name: Fix and Debug images.txt
      run: |
        echo "=== Fixing images.txt encoding ==="
        # 转换文件编码并移除特殊字符
        if [ -f "images.txt" ]; then
          # 备份原文件
          cp images.txt images.txt.backup
          # 转换换行符并清理文件
          dos2unix images.txt 2>/dev/null || true
          # 使用 sed 清理文件，移除不可见字符
          sed -i 's/\r$//' images.txt
          sed -i 's/[^[:print:]\t]//g' images.txt
          
          echo "Cleaned images.txt content:"
          cat -A images.txt
          echo ""
          echo "Line by line analysis:"
          cat -n images.txt | while read num line; do
            echo "Line $num: '$line' (length: ${#line})"
          done
        else
          echo "images.txt not found"
          exit 1
        fi

    - name: Sync All Images
      run: |
        echo "=== Syncing All Images ==="
        
        if [ ! -f "images.txt" ]; then
          echo "ERROR: images.txt not found"
          exit 1
        fi
        
        # 使用数组来存储镜像列表，确保处理所有行
        mapfile -t IMAGES < <(grep -v '^[[:space:]]*#' images.txt | grep -v '^[[:space:]]*$' | sed 's/[^[:print:]]//g')
        
        echo "Found ${#IMAGES[@]} images to sync:"
        for i in "${!IMAGES[@]}"; do
          echo "  $((i+1)). ${IMAGES[$i]}"
        done
        echo ""
        
        COUNT=0
        for IMAGE in "${IMAGES[@]}"; do
          COUNT=$((COUNT + 1))
          echo "--- Processing image $COUNT: $IMAGE ---"
          
          # 验证镜像名称格式
          if [[ ! "$IMAGE" =~ ^[a-zA-Z0-9][a-zA-Z0-9_.-]*(/[a-zA-Z0-9][a-zA-Z0-9_.-]*)*(:[a-zA-Z0-9][a-zA-Z0-9_.-]*)?$ ]]; then
            echo "⚠️ WARNING: Skipping invalid image name: $IMAGE"
            continue
          fi
          
          # Pull image
          echo "Pulling source image..."
          if ! docker pull "$IMAGE"; then
            echo "❌ FAILED to pull: $IMAGE"
            continue
          fi
          
          # Create target name
          echo "Creating target name..."
          CLEAN_IMAGE=$(echo "$IMAGE" | sed 's|^docker.io/||' | sed 's|^library/||')
          REPO_NAME=$(echo "$CLEAN_IMAGE" | cut -d':' -f1 | sed 's|/|_|g')
          TAG=$(echo "$CLEAN_IMAGE" | cut -d':' -f2)
          
          if [ "$TAG" = "$CLEAN_IMAGE" ]; then
            TAG="latest"
          fi
          
          TARGET_NAME="registry.cn-beijing.aliyuncs.com/liyanchao/${REPO_NAME}:${TAG}"
          echo "Source: $IMAGE"
          echo "Target: $TARGET_NAME"
          
          # Tag and push
          echo "Tagging image..."
          docker tag "$IMAGE" "$TARGET_NAME"
          
          echo "Pushing to target registry..."
          if docker push "$TARGET_NAME"; then
            echo "✅ SUCCESS: $IMAGE → $TARGET_NAME"
          else
            echo "❌ FAILED to push: $TARGET_NAME"
          fi
          echo ""
          
        done
        
        echo "=== COMPLETED ==="
        echo "Total images processed: $COUNT"

    - name: Verify Sync
      run: |
        echo "=== Verification ==="
        echo "Final docker images list:"
        docker images | grep -E "(php|mysql)" || echo "No php/mysql images found"