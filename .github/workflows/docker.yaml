name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Docker Auth
      run: |
        mkdir -p ~/.docker
        AUTH=$(echo -n "æå½¦è¶…0305:${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | base64)
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json
        echo "âœ… Docker è®¤è¯é…ç½®å®Œæˆ"

    - name: Test Push to PHP Namespace
      run: |
        echo "=== æµ‹è¯•æ¨é€åˆ° php å‘½åç©ºé—´ ==="
        docker pull hello-world
        docker tag hello-world registry.cn-beijing.aliyuncs.com/php/test-hello:latest
        echo "å‡†å¤‡æ¨é€åˆ°: registry.cn-beijing.aliyuncs.com/php/test-hello"
        docker push registry.cn-beijing.aliyuncs.com/php/test-hello:latest
        echo "âœ… æµ‹è¯•æ¨é€æˆåŠŸ"

    - name: Sync Images to PHP
      run: |
        echo "=== åŒæ­¥é•œåƒåˆ° php å‘½åç©ºé—´ ==="
        
        if [ ! -f "images.txt" ]; then
          echo "âŒ images.txt ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "images.txt å†…å®¹:"
        cat images.txt
        echo ""
        
        count=0
        
        while IFS= read -r line; do
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
          [[ -z "$line" ]] && continue
          [[ "$line" =~ ^[[:space:]]*# ]] && continue
          
          count=$((count + 1))
          echo "--- å¤„ç†ç¬¬ $count ä¸ªé•œåƒ ---"
          
          # æå–é•œåƒå
          image=$(echo "$line" | awk '{print $NF}')
          echo "åŸå§‹é•œåƒ: $image"
          
          # æ‹‰å–é•œåƒ
          docker pull $image
          
          # æ¨é€åˆ° php å‘½åç©ºé—´
          image_name=$(echo $image | sed 's|/|_|g' | sed 's|:|-|g')
          target_image="registry.cn-beijing.aliyuncs.com/php/$image_name"
          echo "ç›®æ ‡é•œåƒ: $target_image"
          
          # æ ‡è®°å’Œæ¨é€
          docker tag $image $target_image
          docker push $target_image
          
          echo "âœ… å®Œæˆ: $target_image"
          echo ""
          
        done < images.txt
        
        echo "ğŸ‰ æˆåŠŸåŒæ­¥ $count ä¸ªé•œåƒåˆ° php å‘½åç©ºé—´"