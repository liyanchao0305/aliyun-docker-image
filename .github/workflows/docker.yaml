name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Docker
      run: |
        # ç®€å•çš„ Docker è®¾ç½®
        docker version

    - name: Configure Docker Auth
      run: |
        # åˆ›å»ºè®¤è¯é…ç½®
        mkdir -p ~/.docker
        USERNAME="æŽå½¦è¶…0305"
        PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
        REGISTRY="registry.cn-beijing.aliyuncs.com"
        
        AUTH_TOKEN=$(echo -n "${USERNAME}:${PASSWORD}" | base64)
        
        cat > ~/.docker/config.json << EOF
        {
          "auths": {
            "${REGISTRY}": {
              "auth": "${AUTH_TOKEN}"
            }
          }
        }
        EOF
        echo "Docker auth configured for ${REGISTRY}"

    - name: Test Basic Push
      run: |
        # æµ‹è¯•åŸºç¡€æŽ¨é€åŠŸèƒ½
        echo "Testing push to Aliyun Container Registry..."
        
        # æ‹‰å–æµ‹è¯•é•œåƒ
        docker pull hello-world
        
        # æŽ¨é€åˆ°é˜¿é‡Œäº‘
        docker tag hello-world registry.cn-beijing.aliyuncs.com/liyanchao/test-hello:latest
        docker push registry.cn-beijing.aliyuncs.com/liyanchao/test-hello:latest
        
        echo "Push test completed!"

    - name: Process images.txt
      run: |
        # æ£€æŸ¥æ–‡ä»¶
        if [ ! -f "images.txt" ]; then
          echo "ERROR: images.txt not found"
          exit 1
        fi
        
        echo "Processing images from images.txt..."
        echo "File content:"
        cat images.txt
        echo ""
        
        # ç®€å•å¤„ç†ï¼šé€è¡Œè¯»å–å¹¶å¤„ç†
        while IFS= read -r line; do
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
          if [[ -z "$line" ]]; then
            continue
          fi
          if [[ "$line" =~ ^[[:space:]]*# ]]; then
            continue
          fi
          
          echo "Processing: $line"
          
          # æå–é•œåƒåï¼ˆæœ€åŽä¸€ä¸ªå­—æ®µï¼‰
          image=$(echo "$line" | awk '{print $NF}')
          echo "Image: $image"
          
          # æ‹‰å–é•œåƒ
          docker pull $image
          
          # æŽ¨é€åˆ°é˜¿é‡Œäº‘
          target_image="registry.cn-beijing.aliyuncs.com/liyanchao/$(echo $image | sed 's|/|_|g')"
          echo "Pushing to: $target_image"
          
          docker tag $image $target_image
          docker push $target_image
          
          echo "âœ… Done: $target_image"
          echo "---"
          
        done < images.txt
        
        echo "ðŸŽ‰ All images processed!"