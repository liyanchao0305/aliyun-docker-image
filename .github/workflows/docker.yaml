name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Fix Authentication
      run: |
        echo "=== ä¿®å¤è®¤è¯é…ç½® ==="
        
        # æ¸…é™¤æ—§çš„é…ç½®
        rm -rf ~/.docker
        
        # åˆ›å»ºæ–°çš„è®¤è¯é…ç½®
        mkdir -p ~/.docker
        
        # ç›´æŽ¥ä½¿ç”¨æ˜Žç¡®çš„å˜é‡
        USERNAME="æŽå½¦è¶…0305"
        PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
        REGISTRY="registry.cn-beijing.aliyuncs.com"
        
        echo "ç”¨æˆ·å: $USERNAME"
        echo "å¯†ç é•¿åº¦: ${#PASSWORD}"
        echo "ä»“åº“åœ°å€: $REGISTRY"
        
        # ç”Ÿæˆæ­£ç¡®çš„ base64 è®¤è¯ä¿¡æ¯
        AUTH_TOKEN=$(echo -n "$USERNAME:$PASSWORD" | base64 -w 0)
        echo "è®¤è¯Tokené•¿åº¦: ${#AUTH_TOKEN}"
        
        # åˆ›å»ºæ­£ç¡®çš„é…ç½®æ–‡ä»¶
        cat > ~/.docker/config.json << EOF
{
  "auths": {
    "$REGISTRY": {
      "auth": "$AUTH_TOKEN"
    }
  }
}
EOF
        
        echo "=== è®¤è¯æ–‡ä»¶å†…å®¹ ==="
        cat ~/.docker/config.json
        echo ""

    - name: Verify Authentication
      run: |
        echo "=== éªŒè¯è®¤è¯ ==="
        
        # æµ‹è¯•è®¤è¯æ˜¯å¦æœ‰æ•ˆ
        REGISTRY="registry.cn-beijing.aliyuncs.com"
        NAMESPACE="liyanchao"
        
        # æµ‹è¯•æ‹‰å–å…¬å…±é•œåƒ
        docker pull hello-world
        echo "âœ… Docker åŸºç¡€åŠŸèƒ½æ­£å¸¸"
        
        # æµ‹è¯•æŽ¨é€åˆ°é˜¿é‡Œäº‘
        docker tag hello-world ${REGISTRY}/${NAMESPACE}/test-auth-verify:latest
        echo "å°è¯•æŽ¨é€åˆ°: ${REGISTRY}/${NAMESPACE}/test-auth-verify"
        
        if docker push ${REGISTRY}/${NAMESPACE}/test-auth-verify:latest; then
          echo "âœ… è®¤è¯æˆåŠŸï¼é•œåƒå·²æŽ¨é€"
        else
          echo "âŒ è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå¯†ç "
          exit 1
        fi

    - name: Mirror Images
      if: success()
      run: |
        echo "=== å¼€å§‹åŒæ­¥é•œåƒ ==="
        
        if [ ! -f "images.txt" ]; then
          echo "âŒ images.txt æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "images.txt å†…å®¹:"
        cat images.txt
        echo ""
        
        REGISTRY="registry.cn-beijing.aliyuncs.com"
        NAMESPACE="liyanchao"
        
        # å¤„ç†æ¯ä¸ªé•œåƒ
        while IFS= read -r line; do
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
          [[ -z "$line" ]] && continue
          [[ "$line" =~ ^[[:space:]]*# ]] && continue
          
          echo "å¤„ç†: $line"
          
          # æå–é•œåƒå
          image=$(echo "$line" | awk '{print $NF}')
          echo "é•œåƒ: $image"
          
          # æ‹‰å–é•œåƒ
          docker pull $image
          
          # ç”Ÿæˆç›®æ ‡é•œåƒåï¼ˆç®€åŒ–å¤„ç†ï¼‰
          image_name=$(echo $image | sed 's|/|_|g' | sed 's|:|-|g')
          target_image="${REGISTRY}/${NAMESPACE}/${image_name}"
          
          echo "æŽ¨é€åˆ°: $target_image"
          
          # æ ‡è®°å’ŒæŽ¨é€
          docker tag $image $target_image
          docker push $target_image
          
          echo "âœ… å®Œæˆ: $target_image"
          echo "---"
          
        done < images.txt
        
        echo "ðŸŽ‰ æ‰€æœ‰é•œåƒåŒæ­¥å®Œæˆï¼"