name: Docker Image Mirror Debug

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images Debug
    runs-on: ubuntu-latest
    
    steps:
    - name: Check GitHub Secrets
      run: |
        echo "=== 检查 GitHub Secrets ==="
        echo "ALIYUN_REGISTRY_PASSWORD 值: '${{ secrets.ALIYUN_REGISTRY_PASSWORD }}'"
        echo "ALIYUN_REGISTRY_PASSWORD 长度: ${#ALIYUN_REGISTRY_PASSWORD}"
        
        if [ -z "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" ]; then
          echo "❌ ALIYUN_REGISTRY_PASSWORD 为空！"
          echo "请检查："
          echo "1. Secret 名称是否正确：ALIYUN_REGISTRY_PASSWORD"
          echo "2. Secret 值是否已设置"
          echo "3. 是否在正确的仓库中设置"
          exit 1
        else
          echo "✅ ALIYUN_REGISTRY_PASSWORD 已设置"
        fi

    - name: Setup Docker Auth
      if: success()
      run: |
        echo "=== 设置 Docker 认证 ==="
        mkdir -p ~/.docker
        
        USERNAME="李彦超0305"
        PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
        
        echo "用户名: $USERNAME"
        echo "密码: [隐藏]"
        echo "密码长度: ${#PASSWORD} 字符"
        
        AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)
        echo "认证Token 长度: ${#AUTH}"
        
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json
        echo "✅ 认证配置完成"

    - name: Test Push
      if: success()
      run: |
        echo "=== 测试推送 ==="
        docker pull hello-world
        docker tag hello-world registry.cn-beijing.aliyuncs.com/liyanchao/php:debug-test
        docker push registry.cn-beijing.aliyuncs.com/liyanchao/php:debug-test
        echo "✅ 测试成功"