name: Docker Image Mirror

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

jobs:
  mirror-images:
    name: Mirror Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Docker Authentication
      run: |
        echo "=== Setup Docker Auth ==="
        mkdir -p ~/.docker
        USERNAME="李彦超0305"
        PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
        AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)
        echo "{\"auths\":{\"registry.cn-beijing.aliyuncs.com\":{\"auth\":\"$AUTH\"}}}" > ~/.docker/config.json

    - name: Debug images.txt Content
      run: |
        echo "=== Debug images.txt ==="
        if [ -f "images.txt" ]; then
          echo "Raw content with line numbers:"
          cat -n images.txt
          echo ""
          echo "Processing each line:"
          LINE_NUM=0
          while IFS= read -r LINE; do
            LINE_NUM=$((LINE_NUM + 1))
            echo "Line $LINE_NUM: '$LINE'"
            # Remove carriage returns and trim spaces
            CLEAN_LINE=$(echo "$LINE" | tr -d '\r' | xargs)
            if [ -n "$CLEAN_LINE" ] && [[ ! "$CLEAN_LINE" =~ ^[[:space:]]*# ]]; then
              echo "  → Will process: '$CLEAN_LINE'"
            else
              echo "  → Skip (empty or comment)"
            fi
          done < images.txt
        else
          echo "images.txt not found"
          exit 1
        fi

    - name: Sync All Images
      run: |
        echo "=== Syncing All Images ==="
        
        if [ ! -f "images.txt" ]; then
          echo "ERROR: images.txt not found"
          exit 1
        fi
        
        COUNT=0
        while IFS= read -r LINE; do
          # Remove carriage returns and trim spaces
          IMAGE=$(echo "$LINE" | tr -d '\r' | xargs)
          
          # Skip empty lines and comments
          [[ -z "$IMAGE" ]] && continue
          [[ "$IMAGE" =~ ^[[:space:]]*# ]] && continue
          
          COUNT=$((COUNT + 1))
          echo "--- Processing image $COUNT: $IMAGE ---"
          
          # Pull image
          echo "Pulling source image..."
          docker pull $IMAGE
          
          # Create target name
          echo "Creating target name..."
          CLEAN_IMAGE=$(echo "$IMAGE" | sed 's|^docker.io/||' | sed 's|^library/||')
          REPO_NAME=$(echo "$CLEAN_IMAGE" | cut -d':' -f1 | sed 's|/|_|g')
          TAG=$(echo "$CLEAN_IMAGE" | cut -d':' -f2)
          
          if [ "$TAG" = "$CLEAN_IMAGE" ]; then
            TAG="latest"
          fi
          
          TARGET_NAME="registry.cn-beijing.aliyuncs.com/liyanchao/${REPO_NAME}:${TAG}"
          echo "Source: $IMAGE"
          echo "Target: $TARGET_NAME"
          
          # Tag and push
          echo "Tagging image..."
          docker tag $IMAGE $TARGET_NAME
          
          echo "Pushing to target registry..."
          docker push $TARGET_NAME
          
          echo "✅ SUCCESS: $IMAGE → $TARGET_NAME"
          echo ""
          
        done < images.txt
        
        echo "=== COMPLETED ==="
        echo "Total images synced: $COUNT"